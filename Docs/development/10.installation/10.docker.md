# Docker

Um das System lokal zu starten, wird Docker verwendet. Hierbei wird ein Container für die Datenbank und drei Container für die Anwendung erstellt.

## Setup
Es Docker Secrets verwendet, um Informationen in die Container zu bringen.

### Secrets
Es werden folgende Secrets benötigt

#### Datenbank
- `db__root_password` -> `.docker/db/secrets/db__root_password.txt`
- `db__user_password` -> `.docker/db/secrets/db__user_password.txt`

Hierfür existieren Beispiel-Dateien im Verzeichnis `.docker/db/secrets` (diese haben einen . vor dem eigentlichen Namen).
Diese können kopiert und angepasst werden.

### Initialisierung
Wenn man das Projekt das erste Mal startet:
```bash
docker-compose up -d --build
```

Jetzt sollten alle Container starten. Das Backend sollte jetzt nicht funktionieren, da die Datenbank noch nicht migriert wurde.

### Migration
Um die Datenbank zu migrieren, wird ein weiterer Container gestartet:
```bash
docker-compose up migration
```

Jetzt muss man das Backend neu starten:
```bash
docker-compose down backend # sollte auch ohne down funktionieren
docker-compose up -d backend
```

### Temporary: 'Workaround' solange wir noch keine Auth haben:
```bash
docker exec -it ugh-db-1 mysql -u root -p
GRANT ALL PRIVILEGES ON db.* TO 'user'@'localhost' IDENTIFIED BY 'password';
FLUSH PRIVILEGES;
```

## Entwicklung
Wenn man nun mit der Entwicklung beginnen möchte, reicht es, die Container zu starten:
```bash
docker-compose up -d
```

### Datenbankänderungen
Sollte es Änderungen an der Datenbank geben, dann müssen diese migriert werden. Siehe dazu [Setup#Migration](#migration).

## Zugriff auf die Datenbank
```bash
docker compose exec -it db mysql -u user -p
```

## Anpassungen
Wenn man Anpassungen an der Konfiguration machen möchte, kann man die compose.yaml im Root-Verzeichnis überschreiben (Siehe auch: [docs.docker.com](https://docs.docker.com/compose/multiple-compose-files/merge/))

Für tiefergehende Eingriffe (z.B. an der Dockerfile), benötigt man die Dateien im Verzeichnis `.docker`. Hier befindet sich für jeden Service ein Ordner.

## Troubleshooting
Windows User:  
If you get an error `ERROR: error during connect: in the default daemon configuration on Windows, the docker client must be run with elevated privileges to connect: ... The system cannot find the file specified.`

make sure Docker Desktop is running.  
Proof this by checking your status in Docker Desktop's left bottom corner, should display
> Engine running

If you did `docker-compose up migration`, you need to make sure to start `docker-compose up server` after that. Always check with `docker ps` if you're not sure which container are running atm 
